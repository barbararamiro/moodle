YUI.add("moodle-mod_lesson-pagemmove",function(e,t){function n(){n.superclass.constructor.apply(this,arguments)}var r={MAINCONTAINER:".mod_lesson_main",LESSONPAGES:".mod_lesson_pages",PAGEMODULES:".mod_lesson_page_element"},i={PAGEWIDTH:300,PAGEHEIGHT:100,PATHFILL:{color:"#ff0000"},PAGEFILL:{color:"#ddddff"},PATHSTROKE:{weight:2,color:"#ff0000"},PAGESTROKE:{weight:2,color:"#000000"}},s=M.cfg.wwwroot+"/mod/lesson/ajax.php";e.namespace("M.mod_lesson").PagemMove=e.extend(n,e.Base,{graphic:null,drawJump:function(e,t){var n=this.graphic.addShape({type:"path",stroke:i.PATHSTROKE,fill:i.PATHFILL});n.moveTo(e.x+e.width/2,e.y+e.height),n.lineTo(t.x+e.width/2,t.y),n.end(),e.jumpShapes[e.jumpShapes.length]=n},drawJumps:function(e,t){var n=0,r=0,i="jumpto["+r+"]";while(e.hasOwnProperty(i)){nextpageid=e[i],nextpageid==="-1"&&(nextpageid=e.nextpageid);for(n=0;n<t.length;n++)t[n].id===nextpageid&&this.drawJump(e,t[n]);r+=1,i="jumpto["+r+"]"}},redrawPage:function(t){var n=e.one(r.LESSONPAGES),i;t.titleNode.setXY([t.x+n.getX()+10,t.y+n.getY()+10]),t.shapeNode.setXY([t.x+n.getX(),t.y+n.getY()]),i=t.jumpShapes.pop();while(typeof i!="undefined")this.graphic.removeShape(i),i=t.jumpShapes.pop();var s=this.get("pages");this.drawJumps(t,s)},redrawAllPages:function(){var e=this.get("pages"),t=0,n;for(t=0;t<e.length;t++)n=e[t],this.redrawPage(n)},drawPage:function(t,n){var s=e.one(r.LESSONPAGES),o=this.get("pages");t.x=n.x,t.y=n.y,t.width=i.PAGEWIDTH,t.height=i.PAGEHEIGHT,t.qtype==="30"&&(t.width=t.clusterchildrenids.length*330,t.height=200,t.clusterchildrenids.length>3&&(t.width=990,t.height=Math.ceil(t.clusterchildrenids.length/3)*200,console.log(t.height))),t.jumpShapes=[];var u=this.graphic.addShape({type:e.Rect,width:t.width,height:t.height,x:n.x,y:n.y,fill:i.PAGEFILL,stroke:i.PAGESTROKE});t.shapeNode=u;var a=e.Node.create('<div style="cursor: pointer; width: 200px;">'+e.Escape.html(t.qtypestr)+": "+e.Escape.html(t.title)+"</div>");s.append(a),t.titleNode=a,a.setXY([n.x+s.getX()+10,n.y+s.getY()+10]);var f=(new e.DD.Drag({node:a})).plug(e.Plugin.DDConstrained,{constrain2node:r.MAINCONTAINER});f.on("drag:drag",function(e){t.x=e.pageX-s.getX()-10,t.y=e.pageY-s.getY()-10,this.redrawAllPages()},this),f.on("drag:end",function(e){console.log(t),this.savePosition(t)},this)},savePosition:function(t){var n=s,r;r={method:"post",context:this,sync:!1,data:{action:"saveposition",lessonid:t.lessonid,pageid:t.id,pagex:t.x,pagey:t.y},on:{success:function(t,n){var r;try{r=e.JSON.parse(n.response)}catch(i){}},failure:function(e,t){alert("something went wrong")}}},YUI().use("io-base",function(e){e.io(n,r)})},initializer:function(){this.graphic=new e.Graphic({render:r.LESSONPAGES});var t=this.get("pages"),n=0,i,s,o={x:0,y:0};for(n=0;n<t.length;n++)i=t[n],i.x!==0?s={x:parseInt(i.x),y:parseInt(i.y)}:s=o,this.drawPage(i,s),o.y+=150;for(n=0;n<t.length;n++)i=t[n],this.drawJumps(i,t)}},{NAME:"pagemMove",ATTRS:{pages:{value:null}}}),e.namespace("M.mod_lesson.PagemMove").init=function(e){return new n({pages:e})}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","dd-delegate","dd-plugin","dd-constrain","dd-drop-plugin"]});
