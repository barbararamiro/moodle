define(["jqueryui","jquery"],function(a,b){var c=null,d=0,e="ajax.php",f=function(a,c){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var d=b("#mod_lesson_page_element_"+a).offset(),e=b("#mod_lesson_page_element_"+c).offset(),f=d.left+b("#mod_lesson_page_element_"+a).width(),g=d.top+b("#mod_lesson_page_element_"+a).height(),h=Math.sqrt((e.left-f)*(e.left-f)+(e.top-g)*(e.top-g)),i=Math.atan2(g-e.top,f-e.left)*(180/Math.PI),j=(f+e.left)/2-h/2,k=(g+e.top)/2-1,l="<div class='lessonline' style='left:"+j+"px; top:"+k+"px; width:"+h+"px;";l+=" -moz-transform:rotate("+i+"deg); -webkit-transform:rotate("+i+"deg);",l+=" -o-transform:rotate("+i+"deg); -ms-transform:rotate("+i+"deg);",l+=" transform:rotate("+i+"deg);' />",b("body").append(l)}},g=function(){b(".lessonline").remove();for(var a in c)for(var d=c[a],e=0,g=0,h="jumpto["+e+"]";d.hasOwnProperty(h);)g="-1"===d[h]?d.nextpageid:d[h],"31"===d.qtype?f(d.clusterid,g):"-9"===g?f(d.id,d.id+"1"):"cluster"!==d.location&&f(d.id,g),e+=1,h="jumpto["+e+"]"},h=function(a,c){var d=b(this).find(c.helper).length;d||(c.helper.detach(),b(this).append(c.helper),j())},i=function(a,c){var d=b(this).find(c.helper).length;d&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),j())},j=function(){for(var a in c){var d=c[a];if("30"===c[a].qtype){var e=d.clusterchildrenids.length;0===e&&(e=1);var f=270,g=100,j=b("#mod_lesson_page_element_"+a).height(),k=0,l=0;e>3?(k=3*f,l=j+Math.ceil(e/3)*g):(k=f*e,l=j+1*g),b("#mod_lesson_page_element_"+a).width(k),b("#mod_lesson_page_element_"+a).height(l);var m=b("#mod_lesson_page_element_"+a).offset().left+10,n=m,o=b("#mod_lesson_page_element_"+a).offset().top+80;for(var p in d.clusterchildrenids)p%3===0&&"0"!==p?(o+=110,b("#mod_lesson_page_element_"+d.clusterchildrenids[p]).offset({top:o,left:m}),n=m+b("#mod_lesson_page_element_"+d.clusterchildrenids[p]).width()+30):(b("#mod_lesson_page_element_"+d.clusterchildrenids[p]).offset({top:o,left:n}),n=n+b("#mod_lesson_page_element_"+d.clusterchildrenids[p]).width()+30);b("#mod_lesson_page_element_"+a).droppable({drop:h,out:i})}}},k=function(a,c){pagetype=c.helper.text();var d="<div class='mod_lesson_menu_item'>"+pagetype+"</div>";b(".mod_lesson_menu").append(d),b(".mod_lesson_menu_item").draggable({stop:l})},l=function(a,f){var h,i=f.helper.text();switch(i){case"Content":h="20";break;case"True False":h="2";break;case"Numerical":h="8";break;case"Multiple Choice":h="3";break;default:h="0"}if(!f.helper.hasClass("mod_lesson_page_element")){var j=f.helper.offset();f.helper.addClass("mod_lesson_page_element"),f.helper.removeClass("mod_lesson_menu_item");var k={title:"Default title",contents:"",qtype:h,lessonid:d,location:"normal",previouspageid:"0",nextpageid:"0",positionx:Math.round(j.left),positiony:Math.round(j.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:d,lessondata:k}}).done(function(a){f.helper.attr("id","mod_lesson_page_element_"+a.id);var d='<header id="mod_lesson_page_element_'+a.id+'">'+i+"</header>";d+='<div class="mod_lesson_page_body" id="mod_lesson_page_element_'+a.id+'"></div>',d+='<img src="../../theme/image.php?theme=clean&component=core&image=t%2Fedit" class="mod_lesson_page_object_menu"></div>',b("#mod_lesson_page_element_"+a.id).html(d),a["jumpto[0]"]="-1",c[a.id]=a,c[a.prevpageid].nextpageid=a.id,f.helper.detach(),b(".mod_lesson_pages").append(f.helper),b("#mod_lesson_page_element_"+a.id).offset(j),w(),g()}).fail(function(a){console.log(a)})}w()},m=function(){var a=b.Deferred(),c=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getjumpoptions",lessonid:d}});return c.done(function(b){a.resolve(b)}),c.fail(function(a){console.log(a)}),a.promise()},n=function(a){a.preventDefault(),a.stopPropagation();var d=b(this).parent().parent().parent().parent().attr("id"),e=d.split("_"),f=e[4];q(),b.when(m()).done(function(a){var d='<div class="mod_lesson_page_editor">';d+="<h3>Edit this lesson content page </h3>",d+="<div>Page title</div>",d+='<div><input type="text" id="mod_lesson_title" value="'+c[f].title+'" /></div>',d+="<div>Page contents</div>",d+='<div><textarea id="mod_lesson_contents">'+c[f].contents+"</textarea></div>",d+="<h4>Content 1</h4>",d+="<div>Jump name</div>",d+='<div><input type="text" id="jumpname" /></div>',d+="<div>Jump</div>",d+='<div><select id="mod_lesson_jump_select">',b.each(a,function(a,b){d+='<option value="'+a+'">'+b.title+"</option>"}),d+="</select></div>",d+='<div><button type="button" id="mod_lesson_editor_save_btn">Save</button>',d+='<button type="button" id="mod_lesson_editor_cancel_btn">Cancel</button></div>',d+="</div>",b(".mod_lesson_pages").append(d),b("#mod_lesson_editor_save_btn").click({pageid:f},o),b("#mod_lesson_editor_cancel_btn").click(function(){b(".mod_lesson_page_editor").remove()})})},o=function(a){var c={id:a.data.pageid,title:b("#mod_lesson_title").val()};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"updatelessonpage",lessonid:d,lessondata:c}}).done(function(a){b("#mod_lesson_page_element_"+c.id+"_body").html(c.title),b(".mod_lesson_page_editor").remove()})},p=function(a){if(b(this).parent().children(".mod_lesson_page_object_menu_thing").length)b(this).parent().find(".mod_lesson_page_object_menu_thing").remove();else{var c='<div class="mod_lesson_page_object_menu_thing">';c+="<ul>",c+='<li><a href="#" class="mod_lesson_page_edit">Edit</a></li>',c+='<li><a href="#" class="mod_lesson_page_link">Link</a></li>',c+='<li><a href="#" class="mod_lesson_page_delete">Delete</a></li>',c+="</ul>",c+="</div>",b(this).parent().append(c),b(".mod_lesson_page_delete").on({click:r}),b(".mod_lesson_page_edit").on({click:n}),b(".mod_lesson_page_link").on({click:s})}},q=function(){b(".mod_lesson_main").find(".mod_lesson_page_object_menu_thing").remove()},r=function(a){a.preventDefault();var c=b(this).parents(".mod_lesson_page_element").attr("id"),f=c.split("_"),h=f[4];b.ajax({method:"POST",url:e,dataType:"json",data:{action:"deletelessonpage",lessonid:d,pageid:h}}).done(function(){}).fail(function(a){console.log(a)}),b(this).parents(".mod_lesson_page_element").remove(),q(),g()},s=function(a){a.preventDefault(),a.stopPropagation();var c=b(this).parent().parent().parent().parent().attr("id"),d=c.split("_"),e=d[4];b(".mod_lesson_page_element").click({pageid:e},v),b(".mod_lesson_page_element").hover(t,u)},t=function(){b(this).css("background-color","blue")},u=function(){b(this).css("background-color","white")},v=function(a){var f=this.id,h=f.split("_"),i=h[4],j=a.data.pageid;b(".mod_lesson_page_element").unbind("click"),b(this).css("background-color","white"),b(".mod_lesson_page_element").off("mouseenter mouseleave");var k={pageid:j,jumpid:i};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"linklessonpages",lessonid:d,lessondata:k}}).done(function(a){var b=0,d="jumpto["+b+"]";if("linked"===a){for(;c[j].hasOwnProperty(d);)b+=1,d="jumpto["+b+"]";c[j][d]=i}else if("linked-type2"===a)for(;c[j].hasOwnProperty(d);){if("0"===c[j][d]){c[j][d]=1;break}b+=1,d="jumpto["+b+"]"}else if("unlinked-type1"===a)for(;c[j].hasOwnProperty(d);){if(c[j][d]===i){delete c[j][d];break}b+=1,d="jumpto["+b+"]"}else c[j].nextpageid="0";g()}).fail(function(a){console.log(a)}),q()},w=function(){b(".mod_lesson_page_element").draggable({drag:g,stop:x}),b(".mod_lesson_page_element").unbind("dblclick"),b(".mod_lesson_page_object_menu").unbind("click"),b(".mod_lesson_page_object_menu").on({click:p}),b(".mod_lesson_menu_item").draggable({stop:l})},x=function(a,c){var f=c.helper.position(),g=this.id,h=g.split("_"),i=h[4],j={pageid:i,positionx:Math.round(f.left),positiony:Math.round(f.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"saveposition",lessonid:d,lessondata:j}}).done(function(){})},y=function(){for(elementid in c)if("31"!==c[elementid].qtype){var a=c[elementid].x,d=c[elementid].y,e=b("#mod_lesson_page_element_"+elementid),f=e.parent();e.position({my:"left top",at:"left+"+a+" top+"+d,of:f})}},z=function(a,c){var d=b.Deferred(),f={pageid:c},g=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getlessondata",lessonid:a,lessondata:f}});return g.done(function(a){d.resolve(a)}),g.fail(function(a){console.log(a)}),d.promise()};return{init:function(a,e){d=a,b.when(z(a,e)).done(function(a){c=a,j(),y(),g(),w(),b(".mod_lesson_menu").droppable({out:k,drop:function(a,b){b.draggable.remove()}})})}}});