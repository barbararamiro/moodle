define(["jqueryui","jquery"],function(a,b){var c=null,d=0,e="ajax.php",f=function(a,c){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var d=b("#mod_lesson_page_element_"+a).offset(),e=b("#mod_lesson_page_element_"+c).offset(),f=d.left+b("#mod_lesson_page_element_"+a).width(),g=d.top+b("#mod_lesson_page_element_"+a).height(),h=Math.sqrt((e.left-f)*(e.left-f)+(e.top-g)*(e.top-g)),i=Math.atan2(g-e.top,f-e.left)*(180/Math.PI),j=(f+e.left)/2-h/2,k=(g+e.top)/2-1,l="<div class='lessonline' style='left:"+j+"px; top:"+k+"px; width:"+h+"px;";l+=" -moz-transform:rotate("+i+"deg); -webkit-transform:rotate("+i+"deg);",l+=" -o-transform:rotate("+i+"deg); -ms-transform:rotate("+i+"deg);",l+=" transform:rotate("+i+"deg);' />",b("body").append(l)}},g=function(){b(".lessonline").remove();for(var a in c)for(var d=c[a],e=0,g=0,h="jumpto["+e+"]";d.hasOwnProperty(h);)g="-1"===d[h]?d.nextpageid:d[h],"31"===d.qtype?f(d.clusterid,g):"-9"===g?f(d.id,d.id+"1"):"cluster"!==d.location&&f(d.id,g),e+=1,h="jumpto["+e+"]"},h=function(){for(var a in c)for(var d=0,e=0,f="jumpto["+d+"]";c[a].hasOwnProperty(f);){if(e="-1"===c[a][f]?c[a].nextpageid:c[a][f],"-9"===e){var g="<div class='mod_lesson_page_element' id='mod_lesson_page_element_"+a+"1'>";g+="<header id='mod_lesson_page_element_"+a+"1'>End Of Lesson</header>",g+="<div class='mod_lesson_page_body' id='mod_lesson_page_element_"+a+"1'></div></div>",b("#mod_lesson_page_element_"+a).append(g);var h=a+"1",i={id:h,prevpageid:a,nextpageid:"none",qtype:"-1",eolid:h};c[h]=i}d+=1,f="jumpto["+d+"]"}},i=function(a,c){var d=b(this).find(c.helper).length;d||(c.helper.detach(),b(this).append(c.helper))},j=function(a,c){var d=b(this).find(c.helper).length;d&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper))},k=function(){for(var a in c){var d=c[a];if("30"===c[a].qtype){var e=270,f=100,g=b("#mod_lesson_page_element_"+a).height(),h=0,k=0;d.clusterchildrenids.length>3?(h=3*e,k=g+Math.ceil(d.clusterchildrenids.length/3)*f):(h=e*d.clusterchildrenids.length,k=g+1*f),b("#mod_lesson_page_element_"+a).width(h),b("#mod_lesson_page_element_"+a).height(k);var l=b("#mod_lesson_page_element_"+a).offset().left+10,m=l,n=b("#mod_lesson_page_element_"+a).offset().top+80;for(var o in d.clusterchildrenids)o%3===0&&"0"!==o?(n+=110,b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).offset({top:n,left:l}),m=l+b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).width()+30):(b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).offset({top:n,left:m}),m=m+b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).width()+30);b("#mod_lesson_page_element_"+a).droppable({drop:i,out:j})}}},l=function(){var a="<div class='mod_lesson_menu_item'>Content</div>";b(".mod_lesson_menu").append(a),b(".mod_lesson_menu_item").draggable({stop:m})},m=function(a,f){var h=f.helper.text(),i="0";if("Content"===h&&(i="20"),"True False"===h&&(i="2"),!f.helper.hasClass("mod_lesson_page_element")){var j=f.helper.offset();f.helper.addClass("mod_lesson_page_element"),f.helper.removeClass("mod_lesson_menu_item");var k={title:"Default title",contents:"",qtype:i,lessonid:d,location:"normal",previouspageid:"0",nextpageid:"0",positionx:Math.round(j.left),positiony:Math.round(j.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:d,lessondata:k}}).done(function(a){f.helper.attr("id","mod_lesson_page_element_"+a.id);var d='<header id="mod_lesson_page_element_'+a.id+'">'+h+"</header>";d+='<div class="mod_lesson_page_body" id="mod_lesson_page_element_'+a.id+'"></div>',d+='<img src="../../theme/image.php?theme=clean&component=core&image=t%2Fedit" class="mod_lesson_page_object_menu"></div>',b("#mod_lesson_page_element_"+a.id).html(d),a["jumpto[0]"]="-1",c[a.id]=a,c[a.prevpageid].nextpageid=a.id,f.helper.detach(),b(".mod_lesson_pages").append(f.helper),b("#mod_lesson_page_element_"+a.id).offset(j),v(),g()}).fail(function(a){console.log(a)})}v()},n=function(a){a.preventDefault(),a.stopPropagation();var d=b(this).parent().parent().parent().parent().attr("id"),e=d.split("_"),f=e[4];p();var g='<div class="mod_lesson_page_editor">';g+="<h3>Edit this lesson content page </h3>",g+="<div>Page title</div>",g+='<div><input type="text" id="mod_lesson_title" value="'+c[f].title+'" /></div>',g+="<div>Page contents</div>",g+='<div><textarea id="mod_lesson_contents">'+c[f].contents+"</textarea></div>",g+="<h4>Content 1</h4>",g+="<div>Jump name</div>",g+='<div><input type="text" id="jumpname" /></div>',g+="<div>Jump</div>",g+='<div><select id="jump"><option>Something</option><option>different</option></div>',g+="</div>",b(".mod_lesson_pages").append(g),b(".mod_lesson_page_editor").dblclick(function(){b(this).remove()})},o=function(a){if(b(this).parent().children(".mod_lesson_page_object_menu_thing").length)b(this).parent().find(".mod_lesson_page_object_menu_thing").remove();else{var c='<div class="mod_lesson_page_object_menu_thing">';c+="<ul>",c+='<li><a href="#" class="mod_lesson_page_edit">Edit</a></li>',c+='<li><a href="#" class="mod_lesson_page_link">Link</a></li>',c+='<li><a href="#" class="mod_lesson_page_delete">Delete</a></li>',c+="</ul>",c+="</div>",b(this).parent().append(c),b(".mod_lesson_page_delete").on({click:q}),b(".mod_lesson_page_edit").on({click:n}),b(".mod_lesson_page_link").on({click:r})}},p=function(){b(".mod_lesson_main").find(".mod_lesson_page_object_menu_thing").remove()},q=function(a){a.preventDefault();var c=b(this).parents(".mod_lesson_page_element").attr("id"),f=c.split("_"),h=f[4];b.ajax({method:"POST",url:e,dataType:"json",data:{action:"deletelessonpage",lessonid:d,pageid:h}}).done(function(){}).fail(function(a){console.log(a)}),b(this).parents(".mod_lesson_page_element").remove(),p(),g()},r=function(a){a.preventDefault(),a.stopPropagation();var c=b(this).parent().parent().parent().parent().attr("id"),d=c.split("_"),e=d[4];b(".mod_lesson_page_element").click({pageid:e},u),b(".mod_lesson_page_element").hover(s,t)},s=function(){b(this).css("background-color","blue")},t=function(){b(this).css("background-color","white")},u=function(a){var f=this.id,h=f.split("_"),i=h[4],j=a.data.pageid;b(".mod_lesson_page_element").unbind("click"),b(this).css("background-color","white"),b(".mod_lesson_page_element").off("mouseenter mouseleave");var k={pageid:j,jumpid:i};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"linklessonpages",lessonid:d,lessondata:k}}).done(function(a){var b=0,d="jumpto["+b+"]";if("linked"===a){for(;c[j].hasOwnProperty(d);)b+=1,d="jumpto["+b+"]";c[j][d]=i}else if("linked-type2"===a)for(;c[j].hasOwnProperty(d);){if("0"===c[j][d]){c[j][d]=1;break}b+=1,d="jumpto["+b+"]"}else if("unlinked-type1"===a)for(;c[j].hasOwnProperty(d);){if(c[j][d]===i){delete c[j][d];break}b+=1,d="jumpto["+b+"]"}else c[j].nextpageid="0";g()}).fail(function(a){console.log(a)}),p()},v=function(){b(".mod_lesson_page_element").draggable({drag:g,stop:w}),b(".mod_lesson_page_element").unbind("dblclick"),b(".mod_lesson_page_object_menu").unbind("click"),b(".mod_lesson_page_object_menu").on({click:o}),b(".mod_lesson_menu_item").draggable({stop:m})},w=function(a,c){var f=c.helper.position(),g=this.id,h=g.split("_"),i=h[4],j={pageid:i,positionx:Math.round(f.left),positiony:Math.round(f.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"saveposition",lessonid:d,lessondata:j}}).done(function(){})},x=function(){for(elementid in c)if("31"!==c[elementid].qtype){var a=c[elementid].x,d=c[elementid].y,e=b("#mod_lesson_page_element_"+elementid),f=e.parent();e.position({my:"left top",at:"left+"+a+" top+"+d,of:f})}};return{init:function(a){console.log(a),c=a;var e;for(e in c)break;d=c[e].lessonid,h(),k(),x(),g(),v(),b(".mod_lesson_menu").droppable({out:l,drop:function(a,b){b.draggable.remove()}})}}});